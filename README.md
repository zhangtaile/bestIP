# TCP 延迟测试工具 (latency.py)

这是一个基于 Python 的高效多线程 TCP 延迟测试脚本，专门用于批量测试 IP 地址和端口的响应速度。它会自动绕过系统代理，确保测试结果反映真实的网路连接延迟。

## 🚀 主要功能

*   **多线程并发**：支持自定义线程数，显著提高大量 IP 的测试效率。
*   **多轮测试**：支持对每个地址进行多轮采样，并取最大（最保守）延迟作为最终结果。
*   **自动排序**：测试结果按延迟从小到大排序，连接失败的地址排在最后。
*   **格式验证**：自动校验输入文件中的 IP 和端口格式，过滤无效数据。
*   **环境纯净**：脚本运行时会自动清除系统代理环境变量（如 `http_proxy`），确保测试数据直接且准确。
*   **中断保存**：支持 `Ctrl+C` 随时停止测试，并立即保存已完成部分的测试结果。

## 📋 输入文件要求

默认输入文件为 `proxy.txt`（可通过参数修改）。文件每行格式应为：
```text
IP,端口,地区,数据中心
```
例如：
```text
1.1.1.1,443,美国,Cloudflare
104.16.0.1,80,香港,Cloudflare
```

## 🛠️ 使用方法

### 1. 环境准备
确保已安装 Python 3.6+。无需额外安装依赖库，仅使用 Python 标准库。

### 2. 快速运行
将待测试的地址存入 `proxy.txt`，直接运行：
```bash
python latency.py
```

### 3. 高级用法（命令行参数）
```bash
python latency.py -i <输入文件> -o <输出文件> -t <线程数> -l <循环次数> --timeout <超时时间>
```

**参数说明：**
*   `-i`, `--input`: 指定输入文件路径（默认：`proxy.txt`）。
*   `-o`, `--output`: 指定结果输出文件路径（默认：`latencyresult.txt`）。
*   `-t`, `--threads`: 并发线程数（默认：`5`）。
*   `-l`, `--loops`: 每个地址的测试轮数（默认：`3`）。
*   `--timeout`: 每次连接的超时秒数（默认：`5.0`）。

**示例：**
使用 20 个线程测试 `my_proxies.txt`，每处测试 5 轮：
```bash
python latency.py -i my_proxies.txt -t 20 -l 5
```

## 📊 输出结果说明

输出结果保存在 `latencyresult.txt` 中，格式如下：
```text
1.1.1.1:443#美国 Cloudflare 50.25 ms
104.16.0.1:80#香港 Cloudflare 120.40 ms
8.8.8.8:53# Failed
```
*   **#** 后面是原始输入中的备注信息。
*   **ms** 前的数值为多轮测试中的**最大延迟**（取最大值是为了提供更可靠的性能预期）。
*   **Failed** 表示连接超时或被拒绝。

# bestIP - TCP 延迟测试工具

这是一个多线程 TCP 延迟测试工具集，用于测量并对一系列 IP 地址或代理服务器的连接速度进行排序。

## 功能特性

- **多线程执行**：利用并发线程同时测试多个目标，显著缩短检测时间。
- **严格格式校验**：自动验证 IPv4 地址格式及端口有效范围（1-65535）。
- **保守性能评估**：支持多轮循环测试（Loops），并取每组测试中的**最大延迟**作为最终结果，确保所选 IP 的网络质量在“最差情况”下依然可靠。
- **自动排序输出**：测试结果按延迟从低到高排列，无法连接的地址自动置于文件末尾。
- **双格式支持**：兼容 CSV（文本）和 JSON 两种输入数据源。
- **绕过系统代理**：自动尝试清除系统环境变量中的代理设置（如 `http_proxy`），确保测得的是真实的直连延迟。

## 脚本说明

### 1. `latency.py`
标准延迟测试脚本，适用于简单的 CSV 文本文件。

- **默认输入文件**：`proxy.txt`
- **输入格式**：`IP,端口,地区,数据中心`
- **使用示例**：
  ```bash
  python latency.py -i proxy.txt -t 10 -l 3
  ```

### 2. `httplatency.py`
增强版测试脚本，增加了对 JSON 格式的支持。

- **默认输入文件**：`http.json`
- **支持格式**：
  - **JSON**: 包含 `ip` 和 `port` 字段的对象列表（可选字段：`country_cn`, `city`, `asOrganization`）。
  - **CSV**: 同 `latency.py` 格式。
- **使用示例**：
  ```bash
  python httplatency.py -i http.json --threads 20 --loops 5
  ```

## 命令行配置选项

两个脚本均支持以下参数调整：

| 参数 | 简写 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `--input` | `-i` | (视脚本而定) | 输入文件路径（CSV 或 JSON）。 |
| `--output` | `-o` | `latencyresult.txt` | 排序后的结果保存路径。 |
| `--threads` | `-t` | `5` | 并发执行的线程数量。 |
| `--loops` | `-l` | `3` | 每个地址重复测试的轮数。 |
| `--timeout` | | `5.0` | 每次连接的超时时间（秒）。 |

## 输出格式示例

测试结果将保存为 `latencyresult.txt`，每行包含 IP 详情及实测延迟：

```text
1.1.1.1:80#美国 Cloudflare 25.40 ms
8.8.8.8:53#美国 Google 45.12 ms
127.0.0.1:8080#本地 Failed
```

## 工作流程

1. **预处理**：脚本读取输入并过滤掉格式错误的 IP 或端口。
2. **并发探测**：通过 `ThreadPoolExecutor` 同时发起 TCP 三次握手请求。
3. **数据汇总**：收集每轮测试的耗时，针对每个地址提取其多轮测试中的最大延迟值。
4. **生成报告**：对所有地址进行升序排列（失败者排在最后）并保存到本地。

## `latency.py` 用户文档

### 1. 功能介绍

`latency.py` 是一个用于测量 TCP 连接延迟的 Python 脚本。它从一个指定的输入文件（默认为 `geoIP.txt`）中读取一系列 IP 地址和端口号，然后并发地对这些地址进行多次 TCP 连接测试，以测量连接延迟。脚本会计算每个地址在多次测试中的最大延迟，并根据这个最大延迟对所有地址进行排序，最终将结果写入一个输出文件（默认为 `latencyresult.txt`）。

该脚本特别适用于测试代理服务器或特定网络端点的连通性和响应速度，因为它会尝试绕过系统级别的代理设置，以确保直接测量目标地址的延迟。

### 2. 核心算法与流程

`latency.py` 的核心逻辑围绕着并发的 TCP 连接测试和结果处理。

#### 2.1 代理环境变量清除

在脚本开始执行时，它会主动清除当前进程的以下环境变量：`http_proxy`, `HTTP_PROXY`, `https_proxy`, `HTTPS_PROXY`, `all_proxy`, `ALL_PROXY`。
**目的**：这样做是为了确保脚本在测量延迟时，不会受到系统或用户配置的代理服务器的影响，从而直接测量目标 IP 地址，获得真实的端到端延迟。

#### 2.2 输入读取

*   脚本会尝试打开名为 `geoIP.txt` 的文件。
*   它会逐行读取文件内容，并将每一行视为一个待测试的地址（格式为 `ip:port`）。
*   如果文件不存在或为空，脚本会打印相应的错误或警告信息并退出。

#### 2.3 并发延迟测量

*   **循环测试**：脚本会进行 `num_loops` (默认为 3) 次完整的测试循环。在每个循环中，所有从输入文件中读取的地址都会被测试一次。
*   **并发执行**：为了提高效率，脚本使用 `concurrent.futures.ThreadPoolExecutor` 来并发执行延迟测量任务。`max_concurrency` (默认为 20) 参数控制了同时进行的连接测试数量。
*   **`measure_latency` 函数**：
    *   接收一个 `ip:port` 格式的地址字符串。
    *   解析出 IP 地址和端口号。
    *   记录连接尝试的开始时间。
    *   使用 `socket.create_connection` 尝试建立 TCP 连接，并设置了一个 5 秒的连接超时。
    *   如果连接成功，记录结束时间并计算延迟（毫秒）。
    *   如果连接失败（例如，超时、连接被拒绝、网络不可达等），则返回 `float('inf')` 表示连接失败。
    *   返回地址和对应的延迟值。
*   **实时进度**：在测试过程中，脚本会打印每个地址的测试结果和总体的完成百分比，提供实时的进度反馈。

#### 2.4 结果处理与排序

*   **数据存储**：所有测试结果（每个地址在每次循环中的延迟）都被存储在一个字典 `all_results` 中。
*   **最大延迟计算**：对于每个地址，脚本会从其所有测试结果中找出**最大**的延迟值。选择最大延迟而不是平均延迟或最小延迟，可能是为了识别在最差网络条件下该地址的性能表现。如果某个地址在所有测试中都连接失败，其最大延迟将被记录为 `float('inf')`。
*   **结果排序**：所有地址会根据其计算出的最大延迟进行升序排序（即，延迟最低的地址排在最前面）。

#### 2.5 输出写入

*   脚本将排序后的结果写入名为 `latencyresult.txt` 的文件。
*   每一行包含一个地址及其对应的最大延迟。如果连接失败，则显示 "Failed"。

### 3. 如何使用

1.  **准备输入文件**：
    *   创建一个名为 `geoIP.txt` 的文本文件（如果不存在）。
    *   在文件中，每行写入一个待测试的 IP 地址和端口号，格式为 `IP地址:端口号`。
    *   示例：
        ```
        192.168.1.1:80
        example.com:443
        10.0.0.5:22
        ```
2.  **运行脚本**：
    *   打开终端或命令行。
    *   导航到 `latency.py` 所在的目录。
    *   运行命令：`python latency.py`
3.  **查看结果**：
    *   脚本执行完成后，会在同一目录下生成一个名为 `latencyresult.txt` 的文件。
    *   打开此文件即可查看每个地址的测试结果，它们将按最大延迟从低到高排序。

### 4. 注意事项

*   **超时设置**：单个 TCP 连接的超时时间默认为 5 秒，可以在 `measure_latency` 函数中修改。
*   **并发数**：并发连接的最大数量默认为 20，可以在 `main` 函数中修改 `max_concurrency` 变量。
*   **测试循环数**：每个地址的测试次数默认为 3 次，可以在 `main` 函数中修改 `num_loops` 变量。
*   **网络环境**：测试结果会受到您当前网络环境的显著影响。
*   **防火墙/安全组**：目标服务器的防火墙或安全组设置可能会阻止连接，导致显示 "Failed"。